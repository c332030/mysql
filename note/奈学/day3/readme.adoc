
= day3

== 分布式架构

Sharding Sphere

分布式事务：业务规避

image::image-2021-08-11-20-05-23-964.png[]

image::image-2021-08-11-20-06-28-679.png[Sharding JDBC]

image::image-2021-08-11-20-09-06-910.png[Sharding Proxy]

去中心化：一个地址 +
静态入口：一个地址 +

image::image-2021-08-11-20-09-45-594.png[对比]

线上应用使用 Sharding JDBC +
运维使用 Sharding Proxy +

image::image-2021-08-11-20-15-30-282.png[混合模式]

== 分布式事务

. 强一致性
. 柔性事务（最终一致性）
. 事务消息：不是分布式事务

=== 强一致性

2PC 缺陷：事务协调者崩溃后，事务参与者无法继续

有问题，但是发生概率低

image::image-2021-08-11-20-19-34-011.png[2PC]

第二阶段后，告知参与者是否可提交，然后再提交

3PC 优势：事务协调者崩溃后，超时后提交 +

image::image-2021-08-11-20-22-58-099.png[3PC]

XA 规范

缺点：

. 写入加锁，10 倍性能损耗
. 记录事务执行状态，不支持异地恢复（崩溃后，新起的实例无法恢复）

image::image-2021-08-11-20-29-34-789.png[XA 规范]

=== 最终一致性

==== TCC

出错率高，侵入业务，复杂度高

image::image-2021-08-11-20-32-13-812.png[成功流程]

image::image-2021-08-11-20-32-24-396.png[失败流程]

==== SAGA

缺点：

. 工作量大
. 补偿机制要做幂等性

image::image-2021-08-11-20-38-11-307.png[]

=== 事务消息

XA > TCC = SAGA > TM（事务消息）

消息队列，使用半消息，然后发送确认消息

消息队列要靠谱，只解决了参与者能接受消息，解决成功没有不管，只解决了一般

image::image-2021-08-11-20-41-33-733.png[事务消息]

=== Seata

强一致性

RM：资源管理器 +

image::image-2021-08-11-20-41-42-632.png[Seata]

image::image-2021-08-11-20-44-26-730.png[AT模式]

image::image-2021-08-11-20-48-46-063.png[AT核心设计]

后镜像

image::image-2021-08-11-20-50-30-690.png[AT执行流程]

image::image-2021-08-11-20-50-24-108.png[AT提交]

image::image-2021-08-11-20-53-37-128.png[思考]

image::image-2021-08-11-20-54-01-882.png[AT回滚]

image::image-2021-08-11-20-55-58-482.png[前后镜像]

行锁锁主键

image::image-2021-08-11-20-56-07-255.png[undo log]

分布式事务时，加一个注解，加行锁 +
本地事务时，加一个 Local 事务注解，加行锁 +

image::image-2021-08-11-20-58-15-899.png[业务场景分析]

提交前加全局锁

image::image-2021-08-11-20-58-41-830.png[写隔离-提交]

本地锁住，全局锁超时时回滚，避免死锁

image::image-2021-08-11-21-00-49-323.png[写隔离-回滚]

默认级别：读未提交

image::image-2021-08-11-21-03-03-696.png[读隔离]

实现读已提交：使用当前读，排它锁，在改时不允许读 +
前镜像实现MVCC、可重复读 +

image::image-2021-08-11-21-04-42-765.png[读已提交]

集成

image::image-2021-08-11-21-07-12-137.png[集成]

== 高可用性

冗余部署

image::image-2021-08-11-21-08-43-748.png[冗余部署]

一主多从

image::image-2021-08-11-21-10-04-740.png[一主多从]

级联部署，可靠性低

image::image-2021-08-11-21-09-17-878.png[级联部署]

延迟从，延迟2小时，避免数据丢失

应该拦截 DELETE

image::image-2021-08-11-21-09-42-378.png[延迟库]

高可用，主库挂了时，VIP1 切换到从，恢复后从库变主库，原主库变从库

image::image-2021-08-11-21-12-49-723.png[高可用]

主从切换

image::image-2021-08-11-21-14-25-054.png[主从切换]
