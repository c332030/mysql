
= day1

记录逻辑有序，利用已删除的空间

利用从库压缩已删除的空间

住

== 存储引擎

image::image-2021-08-09-20-33-52-832.png[记录存储]

已删除空间（标记删除）：自由空间。 +
连接起来就是自由空间链表 +

slot：一个个指针，指向记录 +

image::image-2021-08-09-20-35-35-478.png[记录存储]

类似于跳表

image::image-2021-08-09-20-36-36-428.png[存储方式分析]

=== 存储引擎内存管理

image::image-2021-08-09-20-36-15-382.png[内存管理]

数据加载单元：一次加载一页，而不是一条 +
数据内外寸交换：（涉及淘汰算法、脏页） +

ps

. 脏页：内外存数据不一致

image::image-2021-08-09-20-40-19-592.png[]

页面类型

image::image-2021-08-09-20-42-13-691.png[]

==== LRU 内存淘汰

image::image-2021-08-09-20-42-37-830.png[]

全表扫描对内存影响：导致缓存污染，淘汰了热点数据

InnoDB 不单是 LRU，避免淘汰热数据

解决方式：

. 时间 + 频率
. 两个 LRU，一个放热数据，一个放冷数据，满足条件移到热/冷 LRU

LFU：按访问频率

InnoDB 方式

image::image-2021-08-09-20-50-50-694.png[]

冷热分离

image::image-2021-08-09-20-54-24-744.png[]

midpoint 指向 5/8

old -> new

innodb_old_blocks_time old 区大于此值，才有机会进去 new 区

new -> old 只需要保证 midpoint 在 5/8

== 锁实现机制

LRU 有锁情况

image::image-2021-08-09-21-08-44-021.png[]

== 事务实现原理

image::image-2021-08-09-21-20-17-174.png[]

=== MVCC 多版本并发控制

新版本存在指针指向旧版本

image::image-2021-08-09-21-22-32-279.png[]

解决读写冲突

方式：

. 隐藏列

image::image-2021-08-09-21-23-50-556.png[]

=== undo log

image::image-2021-08-09-21-28-55-351.png[]

快照读，旧版本存在 undo log

image::image-2021-08-09-21-30-25-956.png[]

因为 MVVC 每个事务看到是数据不一样，所以得一条条数据去数

image::image-2021-08-09-21-31-04-038.png[清理]

=== redo log

image::image-2021-08-09-21-32-18-712.png[redo log]

image::image-2021-08-09-21-32-35-344.png[作用]

image::image-2021-08-09-21-34-10-969.png[写入流程]

image::image-2021-08-09-21-35-22-361.png[刷盘时机]

0： 数据库崩溃丢 1 秒 +
2： 文件系统崩溃丢 1 秒 +

image::image-2021-08-09-21-37-38-027.png[意义]

redo log 只写修改的部分，而不是写整个页

=== 锁实现原理

image::image-2021-08-09-21-41-00-088.png[]

image::image-2021-08-09-21-42-31-316.png[]

二级索引需要回表，覆盖索引无需回表

image::image-2021-08-09-21-42-43-753.png[]

RC（读已提交）+ 非唯一索引

RR（可重复读）+ 非唯一索引，使用间隙锁

删 phone = 114，两条，又插入一条 114

image::image-2021-08-09-21-46-01-371.png[]

间隙锁：锁区间，避免插入新的重复记录，如：phone = 114

保证两次当前读返回一直的记录

image::image-2021-08-09-21-49-56-872.png[]

全表扫描回锁表

image::image-2021-08-09-21-51-28-242.png[表锁]

image::image-2021-08-09-21-52-53-889.png[]

image::image-2021-08-09-21-53-08-670.png[加锁过程]

image::image-2021-08-09-21-56-31-992.png[加锁过程2]
